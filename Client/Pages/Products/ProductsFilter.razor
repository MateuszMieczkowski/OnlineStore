@using OnlineStore.Shared.Products
@using System.Reflection.Metadata.Ecma335
@using Blazored.LocalStorage
@using OnlineStore.Client.Products.Models
@using OnlineStore.Shared.Clients
@using OnlineStore.Shared.Enums
@inject ILocalStorageService LocalStorage
@inject IProductService ProductService

<div class="w-100 mb-4">
    <MudPaper Elevation="4">
        <MudContainer MaxWidth="MaxWidth.Medium">
            <MudGrid Justify="Justify.FlexStart">
                <MudItem xs="8">
                    <MudTextField Variant="Variant.Outlined" @bind-Value="_filter.SearchPhrase" DebounceInterval="400" OnDebounceIntervalElapsed="StageFilter" Label="Szukaj"/>
                </MudItem>
                <MudItem Class="mt-3">
                    <MudButton StartIcon="@Icons.Material.Filled.Clear" Variant="Variant.Outlined" Color="Color.Secondary" OnClick="Reset">Wyczyść</MudButton>
                </MudItem>
                <MudItem Class="mt-3">
                    <MudButton StartIcon="@Icons.Material.Filled.FilterList" Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@(() => _showFilters = !_showFilters)">Filtry</MudButton>
                </MudItem>
            </MudGrid>
            @if (_showFilters)
            {
                <MudTextField OnDebounceIntervalElapsed="StageFilter" DebounceInterval="400" Variant="Variant.Outlined" Label="Nazwa" @bind-Value="_filter.Name"/>
                <MudTextField OnDebounceIntervalElapsed="StageFilter" DebounceInterval="400" Variant="Variant.Outlined" Label="Krótki opis" @bind-Value="_filter.ShortDescription"/>
                <MudTextField OnDebounceIntervalElapsed="StageFilter" DebounceInterval="400" Variant="Variant.Outlined" Label="Numer referencyjny" @bind-Value="_filter.ReferenceNumber"/>
                <div class="d-flex gap-2">
                    <MudNumericField OnDebounceIntervalElapsed="StageFilter" Format="N2" DebounceInterval="400" Variant="Variant.Outlined" Label="Cena od" @bind-Value="_filter.MinPrice"/>
                    <MudNumericField OnDebounceIntervalElapsed="StageFilter" Format="N2" DebounceInterval="400" Variant="Variant.Outlined" Label="Cena do" @bind-Value="_filter.MaxPrice"/>
                </div>
                <MudSwitch T="bool" CheckedChanged="@((e) => StageGrossFilter(e))" Checked="_filter.FilterGrossPrice" Color="Color.Secondary" Label="Filtruj ceny brutto"/>
                <MudSwitch T="bool" CheckedChanged="@((e) => StageHiddenFilter(e))" Checked="_filter.HiddenOnly" Color="Color.Secondary" Label="Produkty ukryte"/>
            }
        </MudContainer>
    </MudPaper>
</div>

@code {
    [Parameter] public EventCallback<ProductFilterModel> OnFilterChanged { get; set; }

    private bool _showFilters;
    private ProductFilterModel _filter = new();

    protected override async Task OnInitializedAsync()
    {
        var userPreferences = await LocalStorage.GetItemAsync<UserPreferencesDto>(LocalStorageKeys.UserPreferences);
        _filter.FilterGrossPrice = userPreferences?.DisplayedPrice == DisplayedPriceDto.Gross;
    }

    private async Task StageHiddenFilter(bool hiddenOnly)
    {
        _filter.HiddenOnly = hiddenOnly;
        await StageFilter();
    }
    
    private async Task StageGrossFilter(bool filterGrossPrice)
    {
        _filter.FilterGrossPrice = filterGrossPrice;
        await StageFilter();
    }
    
    private async Task StageFilter()
    {
        await OnFilterChanged.InvokeAsync(_filter);
    }

    private async Task Reset()
    {
       _filter.Clear();
        await StageFilter();
    }
}